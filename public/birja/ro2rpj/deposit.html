<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Пополнение - SellBit</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="icon-btn back-btn" onclick="history.back()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 class="app-title">Пополнение баланса</h1>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Amount Input -->
            <section class="amount-section">
                <div class="amount-card">
                    <h3>Сумма пополнения</h3>
                    <div class="amount-input">
                        <input type="number" id="depositAmount" placeholder="0.00" min="1" step="0.01" value="100">
                        <span class="currency">USD</span>
                    </div>
                    <div class="quick-amounts">
                        <button class="amount-btn" onclick="setAmount(50)">$50</button>
                        <button class="amount-btn" onclick="setAmount(100)">$100</button>
                        <button class="amount-btn" onclick="setAmount(250)">$250</button>
                        <button class="amount-btn" onclick="setAmount(500)">$500</button>
                        <button class="amount-btn" onclick="setAmount(1000)">$1,000</button>
                    </div>
                </div>
            </section>

            <!-- Payment Methods -->
            <section class="payment-methods-section">
                <h3>Способ оплаты</h3>
                <div class="payment-methods-list" id="paymentMethodsList">
                    <!-- Payment methods will be loaded dynamically -->
                </div>
            </section>

            <!-- Payment Details -->
            <section class="payment-details-section" id="paymentDetailsSection" style="display: none;">
                <div class="payment-details-card">
                    <h3 id="paymentMethodTitle">Детали оплаты</h3>
                    <div id="paymentDetailsContent">
                        <!-- Payment details will be loaded dynamically -->
                    </div>
                </div>
            </section>

            <!-- Instructions -->
            <section class="instructions-section" id="instructionsSection" style="display: none;">
                <div class="instructions-card">
                    <h3>Инструкции по оплате</h3>
                    <div id="instructionsContent">
                        <!-- Instructions will be loaded dynamically -->
                    </div>
                </div>
            </section>

            <!-- Action Button -->
            <section class="action-section">
                <button class="btn-primary" id="proceedBtn" onclick="proceedToPayment()" disabled>
                    Продолжить
                </button>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-btn" data-page="home">
                <i class="fas fa-home"></i>
                <span>Главная</span>
            </button>
            <button class="nav-btn" data-page="coins">
                <i class="fas fa-coins"></i>
                <span>Монеты</span>
            </button>
            <button class="nav-btn" data-page="portfolio">
                <i class="fas fa-briefcase"></i>
                <span>Портфель</span>
            </button>

            <button class="nav-btn" data-page="settings">
                <i class="fas fa-cog"></i>
                <span>Настройки</span>
            </button>
        </nav>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="exchange-api.js"></script>
    <script>
        let selectedPaymentMethod = null;
        let requisites = null;

        // Инициализация страницы
        document.addEventListener('DOMContentLoaded', function () {
            // Проверяем авторизацию
            if (!window.exchangeAPI.isAuthenticated()) {
                window.location.href = '/';
                return;
            }

            initializePage();
            loadPaymentMethods();
            loadRequisites();
            initializeEventHandlers();
        });

        function initializePage() {
            // Инициализируем навигацию
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const page = btn.dataset.page;
                    navigateToPage(page);
                });
            });

            // Инициализируем кнопки быстрых сумм
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const amount = this.textContent.replace(/[^\d.]/g, '');
                    setAmount(parseFloat(amount));
                });
            });
        }

        function initializeEventHandlers() {
            // Обработчик изменения суммы
            document.getElementById('depositAmount').addEventListener('input', function() {
                updateProceedButton();
            });
        }

        async function loadPaymentMethods() {
            const paymentMethods = [
                {
                    id: 'bank_card',
                    name: 'Банковская карта',
                    icon: 'fas fa-credit-card',
                    description: 'Visa, MasterCard, МИР',
                    color: '#007aff'
                },
                {
                    id: 'bank_transfer',
                    name: 'Банковский перевод',
                    icon: 'fas fa-university',
                    description: 'Перевод на банковский счет',
                    color: '#34c759'
                },
                {
                    id: 'crypto',
                    name: 'Криптовалюта',
                    icon: 'fas fa-coins',
                    description: 'Bitcoin, Ethereum, USDT',
                    color: '#ff9500'
                },
                {
                    id: 'qiwi',
                    name: 'QIWI Кошелек',
                    icon: 'fas fa-wallet',
                    description: 'Пополнение через QIWI',
                    color: '#ff3b30'
                }
            ];

            const container = document.getElementById('paymentMethodsList');
            container.innerHTML = paymentMethods.map(method => `
                <div class="payment-method-item" onclick="selectPaymentMethod('${method.id}')">
                    <div class="payment-method-icon" style="background: ${method.color}">
                        <i class="${method.icon}"></i>
                    </div>
                    <div class="payment-method-info">
                        <div class="payment-method-name">${method.name}</div>
                        <div class="payment-method-description">${method.description}</div>
                    </div>
                    <div class="payment-method-check">
                        <i class="fas fa-check"></i>
                    </div>
                </div>
            `).join('');
        }

        async function loadRequisites() {
            try {
                const response = await fetch('/api/admin/requisites');
                const data = await response.json();
                
                if (data.success) {
                    requisites = data.requisites;
                }
            } catch (error) {
                console.error('Error loading requisites:', error);
            }
        }

        function selectPaymentMethod(methodId) {
            selectedPaymentMethod = methodId;
            
            // Обновляем UI
            document.querySelectorAll('.payment-method-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            const selectedItem = document.querySelector(`[onclick="selectPaymentMethod('${methodId}')"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }

            // Показываем детали оплаты
            showPaymentDetails(methodId);
            updateProceedButton();
        }

        function showPaymentDetails(methodId) {
            const detailsSection = document.getElementById('paymentDetailsSection');
            const instructionsSection = document.getElementById('instructionsSection');
            const detailsContent = document.getElementById('paymentDetailsContent');
            const instructionsContent = document.getElementById('instructionsContent');
            const methodTitle = document.getElementById('paymentMethodTitle');

            detailsSection.style.display = 'block';
            instructionsSection.style.display = 'block';

            switch (methodId) {
                case 'bank_card':
                    methodTitle.textContent = 'Оплата картой';
                    detailsContent.innerHTML = `
                        <div class="requisites-info">
                            <div class="requisites-label">Реквизиты для оплаты:</div>
                            <div class="requisites-value">${requisites?.card_number || 'Не указано'}</div>
                        </div>
                        <div class="payment-note">
                            <i class="fas fa-info-circle"></i>
                            <span>После оплаты средства поступят на ваш баланс в течение 1-3 часов</span>
                        </div>
                    `;
                    instructionsContent.innerHTML = `
                        <ol class="instructions-list">
                            <li>Скопируйте номер карты выше</li>
                            <li>Переведите указанную сумму на эту карту</li>
                            <li>Сохраните чек об оплате</li>
                            <li>Ожидайте зачисления средств</li>
                        </ol>
                    `;
                    break;

                case 'bank_transfer':
                    methodTitle.textContent = 'Банковский перевод';
                    detailsContent.innerHTML = `
                        <div class="requisites-info">
                            <div class="requisites-label">Банковские реквизиты:</div>
                            <div class="requisites-value">${requisites?.bank_details || 'Не указано'}</div>
                        </div>
                        <div class="payment-note">
                            <i class="fas fa-info-circle"></i>
                            <span>После перевода средства поступят на ваш баланс в течение 1-2 рабочих дней</span>
                        </div>
                    `;
                    instructionsContent.innerHTML = `
                        <ol class="instructions-list">
                            <li>Скопируйте банковские реквизиты</li>
                            <li>Выполните перевод в вашем банке</li>
                            <li>Укажите в назначении платежа ваш ID: <strong>${getUserId()}</strong></li>
                            <li>Сохраните документ о переводе</li>
                        </ol>
                    `;
                    break;

                case 'crypto':
                    methodTitle.textContent = 'Криптовалюта';
                    detailsContent.innerHTML = `
                        <div class="requisites-info">
                            <div class="requisites-label">Адрес для оплаты:</div>
                            <div class="requisites-value">${requisites?.crypto_address || 'Не указано'}</div>
                        </div>
                        <div class="payment-note">
                            <i class="fas fa-info-circle"></i>
                            <span>Принимаем: BTC, ETH, USDT (ERC20)</span>
                        </div>
                    `;
                    instructionsContent.innerHTML = `
                        <ol class="instructions-list">
                            <li>Скопируйте адрес кошелька</li>
                            <li>Отправьте криптовалюту на этот адрес</li>
                            <li>Убедитесь, что сумма соответствует указанной в USD</li>
                            <li>Ожидайте подтверждения транзакции</li>
                        </ol>
                    `;
                    break;

                case 'qiwi':
                    methodTitle.textContent = 'QIWI Кошелек';
                    detailsContent.innerHTML = `
                        <div class="requisites-info">
                            <div class="requisites-label">Номер QIWI кошелька:</div>
                            <div class="requisites-value">${requisites?.qiwi_number || 'Не указано'}</div>
                        </div>
                        <div class="payment-note">
                            <i class="fas fa-info-circle"></i>
                            <span>После оплаты средства поступят на ваш баланс в течение 30 минут</span>
                        </div>
                    `;
                    instructionsContent.innerHTML = `
                        <ol class="instructions-list">
                            <li>Скопируйте номер QIWI кошелька</li>
                            <li>Переведите указанную сумму через QIWI</li>
                            <li>Сохраните чек об оплате</li>
                            <li>Ожидайте зачисления средств</li>
                        </ol>
                    `;
                    break;
            }
        }

        function setAmount(amount) {
            document.getElementById('depositAmount').value = amount;
            updateProceedButton();
        }

        function updateProceedButton() {
            const amount = parseFloat(document.getElementById('depositAmount').value) || 0;
            const proceedBtn = document.getElementById('proceedBtn');
            
            if (amount > 0 && selectedPaymentMethod) {
                proceedBtn.disabled = false;
                proceedBtn.textContent = `Пополнить на $${formatCurrency(amount)}`;
            } else {
                proceedBtn.disabled = true;
                proceedBtn.textContent = 'Продолжить';
            }
        }

        function proceedToPayment() {
            const amount = parseFloat(document.getElementById('depositAmount').value);
            
            if (!amount || amount <= 0) {
                showToast('Ошибка', 'Введите корректную сумму', 'error');
                return;
            }

            if (!selectedPaymentMethod) {
                showToast('Ошибка', 'Выберите способ оплаты', 'error');
                return;
            }

            // Создаем запрос на пополнение
            createDepositRequest(amount, selectedPaymentMethod);
        }

        async function createDepositRequest(amount, paymentMethod) {
            try {
                const response = await fetch('/api/deposit/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.exchangeAPI.getToken()}`
                    },
                    body: JSON.stringify({
                        amount: amount,
                        paymentMethod: paymentMethod
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast('Успех', 'Запрос на пополнение создан. Ожидайте зачисления средств.', 'success');
                    
                    // Логируем операцию
                    await window.exchangeAPI.logOperation('deposit_request_created', {
                        amount: amount,
                        paymentMethod: paymentMethod,
                        requestId: data.requestId
                    });
                    
                    // Возвращаемся на главную страницу через 3 секунды
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                } else {
                    showToast('Ошибка', data.errors.join(', '), 'error');
                }
            } catch (error) {
                console.error('Error creating deposit request:', error);
                showToast('Ошибка', 'Не удалось создать запрос на пополнение', 'error');
            }
        }

        function getUserId() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            return user ? user.id : 'unknown';
        }

        function navigateToPage(page) {
            if (page === 'home') {
                window.location.href = 'index.html';
            } else if (page === 'coins') {
                window.location.href = 'coins.html';
            } else if (page === 'portfolio') {
                window.location.href = 'portfolio.html';

            } else if (page === 'settings') {
                window.location.href = 'settings.html';
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function showToast(title, message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-header">
                    <strong>${title}</strong>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="toast-body">${message}</div>
            `;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }
    </script>
</body>

</html>
